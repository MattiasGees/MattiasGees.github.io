<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Terraform remote state - blog.mattiasgees.be
    
  </title>

  <meta name="description" content="Introduction">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <link rel="canonical" href="http://0.0.0.0:4000/2015/07/29/terraform-remote-state/">
  <link rel="alternate" type="application/rss+xml" title="blog.mattiasgees.be" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">blog.mattiasgees.be</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">Posts</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li> -->
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/standard.jpg ')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Terraform remote state</h1>
            
            <h2 class="subheading">Setting up Terraform remote state.</h2>
            
            <span class="meta">Posted by
              <a href="#">Mattias Gees</a>
              on July 29, 2015 &middot; <span class="reading-time" title="Estimated read time">
  
   4 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <h1 id="introduction">Introduction</h1>

<p>For an Amazon AWS project at <a href="http://skyscrapers.eu">work</a>, we are setting up a complete Amazon AWS infrastructure with Terraform. The first step was to setup a VPC, ELBs, RDS and basic EC2 instances.</p>

<p>I started looking into the remote state capabilities of Terraform together with S3 storage, because it lets us work together without the need to check-in the Terraform state files to our source control, while still saving it at a central place.</p>

<p>Putting your Terraform state file on Aamazon S3 has an other advantage: you can use Terraform outputs into other projects. This solution came in handy when we wanted to setup <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">blue/green deployment</a> with AWS autoscaling.</p>

<p>By dividing the static parts (ELB, RDS, VPC, …) from the dynamic parts (Autoscaling groups), we created an extra security layer. When we automate the blue/green deployment through job servers (Jenkins, TravisCI, CircleCI), we have an extra security layer, where we can’t destroy the static parts by accident when deploying a new version of the software.</p>

<h1 id="configure-remote-state">Configure remote state</h1>

<p>First make sure you have AWS API credentials defined in your AWS CLI tool or as environment variable. You need to do this as Terraform remote state does not use your Terraform variables but the system AWS credentials. If you have different AWS accounts where you deploy your infrastructure, you can still put every state file in the same S3 bucket.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Configure with AWS CLI</span>
AWS Access Key ID <span class="o">[</span>None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key <span class="o">[</span>None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name <span class="o">[</span>None]: eu-west-1
Default output format <span class="o">[</span>None]: json

<span class="c"># Export as environment variable</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAIOSFODNN7EXAMPLE
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>eu-west-1
</code></pre></div></div>

<p>Now configure the remote state. This command will automatically detect if there is a current state file on your local disk. If there is one available on your local disk, it will upload that state file to S3. When there is a file on S3, it will download that file to your local disk. S3 state files are saved in the <code class="language-plaintext highlighter-rouge">.terraform</code> folder.</p>

<p>The <code class="language-plaintext highlighter-rouge">key</code> value is how you want to name your state file in the AWS S3 bucket. You can choose this freely, as long as the key is unique for every Terraform project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform remote config <span class="nt">-backend</span><span class="o">=</span>s3 <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"bucket=mybucketname"</span> <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"key=nam_of_key_file"</span>
</code></pre></div></div>

<h1 id="using-remote-state-in-other-terraform-projects">Using remote state in other Terraform projects</h1>

<p>You can use a state file and its <a href="https://terraform.io/docs/configuration/outputs.html">outputs</a> with other projects.</p>

<p>Define some outputs of values you want to use in other projects.</p>

<pre><code class="language-`">output "vpc_id" {
  value = "${aws_vpc.main.id}"
}

output "proxy_subnets" {
  value = "${join(",", aws_subnet.proxy_subnets.*.id)}"
}
</code></pre>

<p>After a terraform apply run you will see the following.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outputs:
  proxy_subnets      = subnet-1232ae34,subnet-abc41234,subnet-abc1e399
  vpc_id             = vpc-1232ae34
</code></pre></div></div>

<p>In a new terraform project you can do the following, to use these two outputs.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>provider "aws" {
  access_key  = "${var.access_key}"
  secret_key  = "${var.secret_key}"
  region = "${var.aws_region}"
}

resource "terraform_remote_state" "remote_state" {
    backend = "s3"
    config {
        bucket = "mybucketname"
        key = "nam_of_key_file"
    }
}

module "app" {
  source = "modules/blue-green"
  name = "app"
  vpc_id = "${terraform_remote_state.remote_state.output.vpc_id}"
  subnets = "${terraform_remote_state.remote_state.output.app_subnets}"
}
</code></pre></div></div>

<p><em>Little side note: To use outputs of modules in other Terraform projects you will also need to define those outputs in your main terraform file. For example:</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>output "vpc_id" {
  value = "${module.vpc.vpc_id}"
}
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>

<p>It is true what Hashicorp <a href="https://terraform.io/docs/state/remote.html">says</a>: Putting your state somewhere remote (S3, Atlas,Consul) improves safety and teamwork and I see a lot of advantages for the Terraform remote state. I hope that sometime in the near future we can configure the remote state through config file instead of command line, see the <a href="https://github.com/hashicorp/terraform/issues/1964">following GitHub issue.</a></p>

<p>My current blue/green Terraform deployment is mostly based on <a href="https://twitter.com/phinze">@phinze</a> <a href="https://github.com/phinze/tf-bluegreen-asg-deployment">example</a>.</p>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/2015/04/07/rhev-to-opennebula/" data-toggle="tooltip" data-placement="top" title="RHEV VM to OpenNebula VM">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2017/03/07/high-availability-in-the-cloud/" data-toggle="tooltip" data-placement="top" title="High Availability in the cloud">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:mattias.gees@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/MattiasGees">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          <li class="list-inline-item">
            <a href="https://www.linkedin.com/in/mattiasgees">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://github.com/MattiasGees">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy;  2022</p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>
